---
import fs from "node:fs/promises";
import type { MarkdownLayoutProps } from "astro";
import type { BlogPostFrontmatter } from "@types";
import Base from "./Base.astro";
import { formattedDate } from "@utils";
import { Picture } from "@astrojs/image/components";

type Props = MarkdownLayoutProps<BlogPostFrontmatter>;

const { title, date, draft } = Astro.props.frontmatter;
const { url } = Astro.props;
const slug = url?.split("/").pop();

let imageExists = true;
try {
  await fs.stat(new URL(`../../public/images/${slug}.jpg`, import.meta.url));
} catch {
  imageExists = false;
}
---

<Base title="Blog post">
  <div class="mb-8">
    {
      draft && (
        <span class="bg-red-700 text-white inline-block px-2 mb-4">
          [Draft]
        </span>
      )
    }

    <h1 class="text-3xl mb-2">{title}</h1>
    <p>{formattedDate(date)}</p>
  </div>

  {
    imageExists && (
      <Picture
        src={`/images/${slug}.jpg`}
        class="mb-8"
        widths={[400, 600, 1024]}
        sizes="(max-width: 400px) 400px, (max-width: 600px) 600px, 1024px"
        aspectRatio={5 / 3}
        alt={title}
      />
    )
  }

  <div class="prose">
    <slot />
  </div>
</Base>
